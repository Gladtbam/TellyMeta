<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>TellyMeta è®¾ç½®</title>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #999);
            --link-color: var(--tg-theme-link-color, #2481cc);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --destructive-text-color: var(--tg-theme-destructive-text-color, #ff3b30);
            --section-header-text-color: var(--tg-theme-section-header-text-color, #6d6d72);
        }

        body {
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: flex-end; /* åº•éƒ¨å¼¹å‡º */
        }
        
        .modal {
            background: var(--bg-color);
            width: 100%;
            max-height: 90vh;
            border-radius: 12px 12px 0 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .modal.open {
            transform: translateY(0);
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .modal-close {
            color: var(--link-color);
            cursor: pointer;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            font-size: 13px;
            color: var(--hint-color);
            margin-bottom: 5px;
            display: block;
        }

        .form-input, .form-select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--secondary-bg-color);
            background: var(--secondary-bg-color);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        .form-input:focus, textarea:focus {
            border-color: var(--link-color);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* åˆ—è¡¨æ ·å¼ */
        .container { padding: 16px; padding-bottom: 100px; }
        .section-title { font-size: 13px; color: var(--section-header-text-color); text-transform: uppercase; margin: 24px 0 8px 16px; }
        .section-title:first-child { margin-top: 8px; }
        .section-hint { font-size: 13px; color: var(--hint-color); margin: 8px 16px; line-height: 1.4; }
        .card { background-color: var(--bg-color); border-radius: 10px; overflow: hidden; }
        .item { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid var(--secondary-bg-color); transition: background-color 0.2s; }
        .item:active { background-color: var(--secondary-bg-color); }
        .item:last-child { border-bottom: none; }
        .item-content { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .item-title { font-size: 17px; font-weight: 400; }
        .item-subtitle { font-size: 14px; color: var(--hint-color); margin-top: 4px; }
        .item-status { font-size: 12px; margin-left: 10px; flex-shrink: 0; }
        
        /* å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0; margin-left: 12px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .3s; border-radius: 34px; }
        @media (prefers-color-scheme: dark) { .slider { background-color: #39393d; } }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* æŒ‰é’®æ ·å¼ */
        .btn { background-color: var(--bg-color); color: var(--link-color); border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 17px; cursor: pointer; text-align: center; margin-top: 10px; }
        .btn-primary { background-color: var(--button-color); color: #fff; margin-top: 20px; }
        .btn-danger { color: var(--destructive-text-color); margin-top: 20px; }
        .btn-sm { padding: 8px 12px; font-size: 14px; width: auto; margin-top: 0; border-radius: 6px; background-color: var(--secondary-bg-color); }
        
        /* Tabs æ ·å¼ */
        .tabs { display: flex; border-bottom: 1px solid var(--secondary-bg-color); margin-bottom: 15px; flex-shrink: 0; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--hint-color); font-weight: 500; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .tab-content { display: none; padding-bottom: 20px; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Path Mapping åˆ—è¡¨ä¼˜åŒ– */
        .mapping-item { 
            background: var(--secondary-bg-color);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 12px; 
            border-radius: 10px; 
            margin-bottom: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .mapping-arrow {
            text-align: center;
            color: var(--hint-color);
            font-size: 12px;
            font-weight: 500;
        }
        .state-text { padding: 20px; text-align: center; color: var(--hint-color); font-size: 14px; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="section-title">Bot ç®¡ç†å‘˜</div>
        <div class="section">
            <div class="card" id="admin-list"><div class="state-text">åŠ è½½ä¸­...</div></div>
        </div>

        <div class="section-title">åª’ä½“æœåŠ¡å™¨</div>
        <div class="section">
            <div class="card" id="server-list"><div class="state-text">åŠ è½½ä¸­...</div></div>
            <button class="btn" onclick="openAddServerModal()">æ·»åŠ æœåŠ¡å™¨</button>
        </div>

        <div class="section-title">ç³»ç»ŸåŠŸèƒ½</div>
        <div class="section">
            <div class="card">
                <div class="item"><div class="item-content"><span class="item-title">ç§¯åˆ†/ç­¾åˆ°åŠŸèƒ½</span></div><label class="switch"><input type="checkbox" id="toggle-points" onchange="toggleSystem('enable_points')"><span class="slider"></span></label></div>
                <div class="item"><div class="item-content"><span class="item-title">å…¥ç¾¤éªŒè¯</span></div><label class="switch"><input type="checkbox" id="toggle-verification" onchange="toggleSystem('enable_verification')"><span class="slider"></span></label></div>
                <div class="item"><div class="item-content"><span class="item-title">æ±‚ç‰‡åŠŸèƒ½</span></div><label class="switch"><input type="checkbox" id="toggle-requestmedia" onchange="toggleSystem('enable_requestmedia')"><span class="slider"></span></label></div>
                <div class="item"><div class="item-content"><span class="item-title">æ¸…ç†ä¸åœ¨ç¾¤æˆå‘˜</span></div><label class="switch"><input type="checkbox" id="toggle-cleanup" onchange="toggleSystem('enable_cleanup_inactive_users')"><span class="slider"></span></label></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="server-modal">
        <div class="modal">
            <div class="modal-header">
                <span id="modal-title">æœåŠ¡å™¨è®¾ç½®</span>
                <span class="modal-close" onclick="closeModal('server-modal')">å–æ¶ˆ</span>
            </div>
            
            <div class="tabs" id="srv-tabs" style="display:none">
                <div class="tab active" onclick="switchTab('basic')">åŸºç¡€</div>
                <div class="tab" onclick="switchTab('policy')" id="tab-policy">ç­–ç•¥</div>
                <div class="tab" onclick="switchTab('paths')" id="tab-paths">è·¯å¾„</div>
                <div class="tab" onclick="switchTab('advanced')">é«˜çº§</div>
            </div>

            <form id="server-form" onsubmit="handleServerSubmit(event)" style="overflow-y:auto; flex:1;">
                <input type="hidden" id="srv-id">
                
                <div id="tab-content-basic" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">å¯ç”¨çŠ¶æ€</label>
                        <div class="item" style="padding:0; border:none; background:transparent">
                            <span>å¯ç”¨æ­¤æœåŠ¡å™¨</span>
                            <label class="switch"><input type="checkbox" id="srv-enabled"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">åç§°</label><input type="text" class="form-input" id="srv-name" required placeholder="æœåŠ¡å™¨æ˜µç§°"></div>
                    <div class="form-group"><label class="form-label">ç±»å‹</label><select class="form-select" id="srv-type"><option value="emby">Emby</option><option value="jellyfin">Jellyfin</option><option value="sonarr">Sonarr</option><option value="radarr">Radarr</option></select></div>
                    <div class="form-group"><label class="form-label">åœ°å€ (URL)</label><input type="url" class="form-input" id="srv-url" required placeholder="http://127.0.0.1:8096"></div>
                    <div class="form-group"><label class="form-label">API Key</label><input type="text" class="form-input" id="srv-key" required placeholder="API Key"></div>
                    <div class="form-group">
                        <label class="form-label">Webhook URL (ç‚¹å‡»å¤åˆ¶)</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="srv-webhook" readonly onclick="this.select(); document.execCommand('copy'); tg.showAlert('å·²å¤åˆ¶');" style="background: #eee; color: #555;">
                        </div>
                        <div class="section-hint" style="margin: 4px 0 0 0;">è¯·å°†æ­¤åœ°å€å¡«å…¥ Jellyfin/Emby/Sonarr/Radarr çš„ Webhook è®¾ç½®ä¸­ã€‚</div>
                    </div>
                </div>

                <div id="tab-content-policy" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">æ³¨å†Œæ¨¡å¼</label>
                        <select class="form-select" id="srv-reg-mode" onchange="onRegModeChange()">
                            <option value="default">é»˜è®¤ (ä»…é‚€è¯·/ç§¯åˆ†)</option>
                            <option value="open">å®Œå…¨å¼€æ”¾</option>
                            <option value="count">åé¢é™åˆ¶</option>
                            <option value="time">é™æ—¶å¼€æ”¾</option>
                            <option value="external">å¤–éƒ¨éªŒè¯</option>
                            <option value="close">å…³é—­æ³¨å†Œ</option>
                        </select>
                    </div>
                    
                    <div id="reg-extra-count" class="form-group" style="display:none">
                        <label class="form-label">å‰©ä½™åé¢</label>
                        <input type="number" class="form-input" id="srv-reg-count">
                    </div>
                    <div id="reg-extra-time" class="form-group" style="display:none">
                        <label class="form-label">æˆªæ­¢æ—¶é—´</label>
                        <input type="datetime-local" class="form-input" id="srv-reg-time-picker" onchange="updateTimestamp()">
                        <input type="hidden" id="srv-reg-time"> 
                    </div>
                    <div id="reg-extra-ext" style="display:none">
                        <div class="form-group"><label class="form-label">éªŒè¯ URL å‰ç¼€</label><input type="text" class="form-input" id="srv-reg-url" placeholder="http://..."></div>
                        <div class="form-group"><label class="form-label">è§£æä»£ç  (Python è¡¨è¾¾å¼)</label><textarea class="form-input" id="srv-reg-parser" placeholder="response.status_code == 200"></textarea></div>
                    </div>

                    <div class="form-group" style="display:flex; gap:10px">
                        <div style="flex:1">
                            <label class="form-label">è´¦æˆ·æœ‰æ•ˆæœŸ (å¤©)</label>
                            <input type="number" class="form-input" id="srv-reg-days" placeholder="0ä¸ºæ°¸ä¹…">
                        </div>
                        <div style="flex:1">
                            <label class="form-label">é‚€è¯·ç æœ‰æ•ˆæœŸ (å¤©)</label>
                            <input type="number" class="form-input" id="srv-code-days" placeholder="é»˜è®¤30">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·åè®® (TOS)</label>
                        <textarea class="form-input" id="srv-tos" rows="4" placeholder="æ”¯æŒ Markdown æ ¼å¼"></textarea>
                    </div>

                    <div class="item" style="padding:0; border:none; background:transparent; margin-bottom:15px;">
                        <span>å¼€å¯ NSFW é™åˆ¶</span>
                        <label class="switch"><input type="checkbox" id="srv-nsfw"><span class="slider"></span></label>
                    </div>
                    <button type="button" class="btn btn-sm" onclick="openNsfwModal()">ğŸ” ç®¡ç† NSFW åª’ä½“åº“</button>
                    <button type="button" class="btn btn-sm" style="margin-top:10px" onclick="openLibraryModal()">ğŸ“‚ åª’ä½“åº“ç»‘å®š</button>
                </div>

                <div id="tab-content-paths" class="tab-content">
                    <div class="section-hint">å°† Sonarr/Radarr çš„å®¹å™¨è·¯å¾„æ˜ å°„åˆ° Bot çš„æœ¬åœ°è·¯å¾„ï¼Œä»¥ä¾¿ Bot è¯»å–æ–‡ä»¶ä¿¡æ¯ã€‚</div>
                    <div id="path-mappings-list"></div>
                    <button type="button" class="btn btn-sm" onclick="addPathMapping()">+ æ·»åŠ è·¯å¾„æ˜ å°„</button>
                </div>

                <div id="tab-content-advanced" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">å¸¸è§„é€šçŸ¥é¢‘é“</label>
                        <select class="form-select" id="srv-notify-topic"><option value="0">æœªè®¾ç½®</option></select>
                    </div>
                    <div class="form-group" id="req-topic-group">
                        <label class="form-label">æ±‚ç‰‡é€šçŸ¥é¢‘é“</label>
                        <select class="form-select" id="srv-req-topic"><option value="0">æœªè®¾ç½®</option></select>
                    </div>
                    <div id="sonarr-actions" style="display:none; margin-top: 20px; border-top: 1px solid var(--secondary-bg-color); padding-top: 15px;">
                        <div class="section-hint">é«˜çº§ç»´æŠ¤å·¥å…·</div>
                        <button type="button" class="btn btn-sm" onclick="triggerRebuildMetadata()">ğŸ”„ é‡å»ºå…ƒæ•°æ® (ç”Ÿæˆ NFO)</button>
                        <div class="section-hint">æ­¤æ“ä½œå°†éå†æ‰€æœ‰å‰§é›†å¹¶é‡æ–°ç”Ÿæˆ NFO æ–‡ä»¶ï¼Œè€—æ—¶è¾ƒé•¿ï¼Œè¯·å‹¿é¢‘ç¹ç‚¹å‡»ã€‚</div>
                    </div>
                    <div class="section-hint" style="margin-top:20px; color:var(--destructive-text-color)">å±é™©åŒºåŸŸ</div>
                    <button type="button" class="btn btn-danger" onclick="deleteServer()">åˆ é™¤æ­¤æœåŠ¡å™¨</button>
                </div>

                <div style="margin-top:20px;">
                    <button type="submit" class="btn btn-primary" id="btn-save">ä¿å­˜é…ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="nsfw-modal" style="z-index: 1100;">
        <div class="modal">
            <div class="modal-header"><span>NSFW åª’ä½“åº“</span><span class="modal-close" onclick="closeModal('nsfw-modal')">å…³é—­</span></div>
            <div class="card" id="nsfw-list"><div class="state-text">åŠ è½½ä¸­...</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="library-modal" style="z-index: 1100;">
        <div class="modal">
            <div class="modal-header"><span>åª’ä½“åº“ç»‘å®š</span><span class="modal-close" onclick="closeModal('library-modal')">å…³é—­</span></div>
            <div class="card" id="lib-list"><div class="state-text">åŠ è½½ä¸­...</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="binding-modal" style="z-index: 1200;">
        <div class="modal">
            <div class="modal-header"><span id="bind-title">é…ç½®ç»‘å®š</span><span class="modal-close" onclick="closeModal('binding-modal')">è¿”å›</span></div>
            <form id="binding-form" onsubmit="handleBindingSubmit(event)">
                <input type="hidden" id="bind-lib-name">
                <div class="form-group">
                    <label class="form-label">Sonarr/Radarr å®ä¾‹</label>
                    <select class="form-select" id="bind-server" onchange="onBindServerChange()"><option value="">æœªç»‘å®š</option></select>
                </div>
                <div id="bind-details" style="display:none">
                    <div class="form-group"><label class="form-label">è´¨é‡é…ç½®</label><select class="form-select" id="bind-quality"></select></div>
                    <div class="form-group"><label class="form-label">æ ¹ç›®å½•</label><select class="form-select" id="bind-folder"></select></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ç»‘å®š</button>
                <button type="button" class="btn btn-danger" onclick="unbindLibrary()">è§£é™¤ç»‘å®š</button>
            </form>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        let topicList = [], currentServerId = null;

        async function api(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'X-Telegram-Init-Data': tg.initData, 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            try {
                const res = await fetch(`/api/settings${endpoint}`, options);
                if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
                return await res.json();
            } catch (e) { tg.showAlert(e.message); throw e; }
        }

        async function loadData() {
            const [sys, admins, servers, topics] = await Promise.allSettled([
                api('/system'), api('/admins'), api('/servers'), api('/topics')
            ]);
            if (topics.status === 'fulfilled') topicList = topics.value;
            if (sys.status === 'fulfilled') {
                for (const [k, v] of Object.entries(sys.value)) document.getElementById(`toggle-${k.split('_')[1]}`).checked = v;
            }
            renderServers(servers.status === 'fulfilled' ? servers.value : []);
            renderAdmins(admins.status === 'fulfilled' ? admins.value : []);
        }

        function renderAdmins(data) {
            const list = document.getElementById('admin-list');
            list.innerHTML = data.length ? '' : '<div class="state-text">æ— æ•°æ®</div>';
            data.forEach(u => {
                list.innerHTML += `<div class="item"><div class="item-content"><span class="item-title">${u.name}</span><span class="item-subtitle">ID: ${u.id}</span></div><label class="switch"><input type="checkbox" ${u.is_bot_admin?'checked':''} onchange="toggleAdmin(${u.id}, this)"><span class="slider"></span></label></div>`;
            });
        }

        function renderServers(data) {
            const list = document.getElementById('server-list');
            list.innerHTML = data.length ? '' : '<div class="state-text">æ— æœåŠ¡å™¨</div>';
            data.forEach(s => {
                list.innerHTML += `<div class="item" onclick='openEditServer(${JSON.stringify(s)})'><div class="item-content"><span class="item-title">${s.name}</span><span class="item-subtitle">${s.server_type} â€¢ ${s.url}</span></div><span class="item-status" style="color:${s.is_enabled?'#34c759':'#ff3b30'}">â—</span><div style="color:var(--hint-color);margin-left:8px">â€º</div></div>`;
            });
        }

        // --- Server Edit ---
        function openAddServerModal() {
            currentServerId = null;
            document.getElementById('server-form').reset();
            document.getElementById('srv-type').disabled = false;
            document.getElementById('srv-enabled').checked = true;
            document.getElementById('srv-tabs').style.display = 'none';
            switchTab('basic');
            openModal('server-modal', 'æ·»åŠ æœåŠ¡å™¨');
        }

        function openEditServer(s) {
            currentServerId = s.id;
            document.getElementById('srv-name').value = s.name;
            document.getElementById('srv-type').value = s.server_type;
            document.getElementById('srv-type').disabled = true;
            document.getElementById('srv-url').value = s.url;
            document.getElementById('srv-key').value = "******";
            document.getElementById('srv-enabled').checked = s.is_enabled;

            const origin = window.location.origin;
            const webhookPath = `/webhook/${s.server_type}?token=${s.webhook_token}`;
            document.getElementById('srv-webhook').value = origin + webhookPath;
            
            fillTopicSelect('srv-notify-topic', s.notify_topic_id);
            fillTopicSelect('srv-req-topic', s.request_notify_topic_id);

            const isMedia = ['emby', 'jellyfin'].includes(s.server_type);
            document.getElementById('tab-policy').style.display = isMedia ? 'block' : 'none';
            document.getElementById('tab-paths').style.display = isMedia ? 'none' : 'block';
            document.getElementById('req-topic-group').style.display = isMedia ? 'none' : 'block';

            const sonarrActions = document.getElementById('sonarr-actions');
            if (sonarrActions) {
                sonarrActions.style.display = (s.server_type === 'sonarr') ? 'block' : 'none';
            }

            if (isMedia) {
                document.getElementById('srv-reg-mode').value = s.registration_mode || 'default';
                document.getElementById('srv-reg-count').value = s.registration_count_limit;
                
                const ts = parseInt(s.registration_time_limit);
                if (ts > 0) {
                    const date = new Date(ts * 1000);
                    const localIso = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                    document.getElementById('srv-reg-time-picker').value = localIso;
                    document.getElementById('srv-reg-time').value = ts;
                } else {
                    document.getElementById('srv-reg-time-picker').value = "";
                    document.getElementById('srv-reg-time').value = "0";
                }

                document.getElementById('srv-reg-url').value = s.registration_external_url || '';
                document.getElementById('srv-reg-parser').value = s.registration_external_parser || '';
                document.getElementById('srv-reg-days').value = s.registration_expiry_days;
                document.getElementById('srv-code-days').value = s.code_expiry_days;
                document.getElementById('srv-tos').value = s.tos || '';
                document.getElementById('srv-nsfw').checked = s.nsfw_enabled;
                onRegModeChange();
            } else {
                renderPathMappings(s.path_mappings || []);
            }

            document.getElementById('srv-tabs').style.display = 'flex';
            switchTab('basic');
            openModal('server-modal', 'ç¼–è¾‘æœåŠ¡å™¨');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabBtn = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }

        function onRegModeChange() {
            const mode = document.getElementById('srv-reg-mode').value;
            document.getElementById('reg-extra-count').style.display = mode === 'count' ? 'block' : 'none';
            document.getElementById('reg-extra-time').style.display = mode === 'time' ? 'block' : 'none';
            document.getElementById('reg-extra-ext').style.display = mode === 'external' ? 'block' : 'none';
        }

        function updateTimestamp() {
            const val = document.getElementById('srv-reg-time-picker').value;
            document.getElementById('srv-reg-time').value = val ? Math.floor(new Date(val).getTime() / 1000) : "0";
        }

        // --- Path Mappings (Updated Layout) ---
        function renderPathMappings(mappings) {
            const container = document.getElementById('path-mappings-list');
            container.innerHTML = '';
            mappings.forEach(m => addPathMapping(m.remote, m.local));
        }

        function addPathMapping(remote = '', local = '') {
            const div = document.createElement('div');
            div.className = 'mapping-item';
            div.innerHTML = `
                <input type="text" class="form-input mapping-input remote" placeholder="è¿œç¨‹è·¯å¾„ (å®¹å™¨å†…/Remote)" value="${remote}">
                <div class="mapping-arrow">â¬‡ï¸ æ˜ å°„åˆ° (Mapped to)</div>
                <input type="text" class="form-input mapping-input local" placeholder="æœ¬åœ°è·¯å¾„ (å®¿ä¸»æœº/Local)" value="${local}">
                <button type="button" class="btn btn-danger btn-sm" style="width:100%; margin-top:5px; background-color:transparent; color:var(--destructive-text-color); border:1px solid var(--destructive-text-color);" onclick="this.parentElement.remove()">åˆ é™¤æ­¤æ˜ å°„</button>
            `;
            document.getElementById('path-mappings-list').appendChild(div);
        }

        async function triggerRebuildMetadata() {
            if (!confirm("ç¡®å®šè¦é‡å»ºæ‰€æœ‰åª’ä½“çš„å…ƒæ•°æ®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸”ä¼šå ç”¨å¤§é‡ API è¯·æ±‚é…é¢ã€‚")) return;
            
            try {
                const res = await api(`/servers/${currentServerId}/rebuild_metadata`, 'POST');
                if (res.success) {
                    tg.showAlert(res.message);
                }
            } catch (e) {
                //
            }
        }

        // --- NSFW Management ---
        async function openNsfwModal() {
            if (!currentServerId) return;
            openModal('nsfw-modal');
            const list = document.getElementById('nsfw-list');
            list.innerHTML = '<div class="state-text">åŠ è½½ä¸­...</div>';
            try {
                const libs = await api(`/servers/${currentServerId}/nsfw_libraries`);
                list.innerHTML = '';
                libs.forEach(l => {
                    list.innerHTML += `
                        <div class="item">
                            <span class="item-title">${l.name}</span>
                            <label class="switch">
                                <input type="checkbox" ${l.is_nsfw ? 'checked' : ''} onchange="toggleNsfwLib('${l.id}')">
                                <span class="slider"></span>
                            </label>
                        </div>`;
                });
            } catch (e) { list.innerHTML = `<div class="state-text">åŠ è½½å¤±è´¥</div>`; }
        }

        async function toggleNsfwLib(libId) {
            await api(`/servers/${currentServerId}/nsfw_libraries/${encodeURIComponent(libId)}/toggle`, 'POST');
        }

        // --- Library Binding ---
        async function openLibraryModal() {
            if (!currentServerId) return;
            const list = document.getElementById('lib-list');
            list.innerHTML = '<div class="state-text">åŠ è½½ä¸­...</div>';
            openModal('library-modal');
            try {
                const libs = await api(`/servers/${currentServerId}/libraries`);
                list.innerHTML = '';
                if(libs.length === 0) list.innerHTML = '<div class="state-text">æ— åº“</div>';
                libs.forEach(lib => {
                    const status = (lib.binding && lib.binding.server_id) ? `ğŸŸ¢ ${lib.binding.server_name}` : "ğŸ”´ æœªç»‘å®š";
                    const el = document.createElement('div'); el.className = 'item';
                    el.onclick = () => openBindingModal(lib);
                    el.innerHTML = `<div class="item-content"><span class="item-title">${lib.name}</span><span class="item-subtitle">${status}</span></div><div>â€º</div>`;
                    list.appendChild(el);
                });
            } catch (e) { list.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        async function openBindingModal(lib) {
            document.getElementById('bind-title').innerText = lib.name;
            document.getElementById('bind-lib-name').value = lib.name;
            const servers = await api('/bindings/options');
            const sel = document.getElementById('bind-server');
            sel.innerHTML = '<option value="">æœªç»‘å®š</option>';
            servers.forEach(s => sel.add(new Option(`${s.name} (${s.type})`, s.id)));
            
            if (lib.binding && lib.binding.server_id) {
                sel.value = lib.binding.server_id;
                await loadArrResources(lib.binding.server_id, lib.binding);
                document.getElementById('bind-details').style.display = 'block';
            } else {
                document.getElementById('bind-details').style.display = 'none';
            }
            openModal('binding-modal');
        }

        async function onBindServerChange() {
            const sid = document.getElementById('bind-server').value;
            document.getElementById('bind-details').style.display = sid ? 'block' : 'none';
            if(sid) loadArrResources(sid);
        }

        async function loadArrResources(sid, binding=null) {
            const qSel = document.getElementById('bind-quality'); qSel.innerHTML = '<option>åŠ è½½ä¸­...</option>';
            const fSel = document.getElementById('bind-folder'); fSel.innerHTML = '<option>åŠ è½½ä¸­...</option>';
            const res = await api(`/arr/${sid}/resources`);
            qSel.innerHTML = ''; res.profiles.forEach(p => qSel.add(new Option(p.name, p.id, false, binding && binding.quality_profile_id == p.id)));
            fSel.innerHTML = ''; res.folders.forEach(f => fSel.add(new Option(f.path, f.path, false, binding && binding.root_folder == f.path)));
        }

        async function handleBindingSubmit(e) {
            e.preventDefault();
            const payload = {
                server_id: parseInt(document.getElementById('bind-server').value),
                quality_profile_id: parseInt(document.getElementById('bind-quality').value),
                root_folder: document.getElementById('bind-folder').value
            };
            await api(`/bindings/${encodeURIComponent(document.getElementById('bind-lib-name').value)}`, 'POST', payload);
            closeModal('binding-modal'); openLibraryModal();
        }

        async function unbindLibrary() {
            await api(`/bindings/${encodeURIComponent(document.getElementById('bind-lib-name').value)}`, 'DELETE');
            closeModal('binding-modal'); openLibraryModal();
        }

        // --- Save Server ---
        async function handleServerSubmit(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('srv-name').value,
                url: document.getElementById('srv-url').value,
                api_key: document.getElementById('srv-key').value,
                is_enabled: document.getElementById('srv-enabled').checked,
                notify_topic_id: parseInt(document.getElementById('srv-notify-topic').value) || 0,
            };

            const type = document.getElementById('srv-type').value;
            if (['emby', 'jellyfin'].includes(type)) {
                payload.registration_mode = document.getElementById('srv-reg-mode').value;
                payload.registration_count_limit = parseInt(document.getElementById('srv-reg-count').value) || 0;
                payload.registration_time_limit = document.getElementById('srv-reg-time').value || "0";
                payload.registration_external_url = document.getElementById('srv-reg-url').value;
                payload.registration_external_parser = document.getElementById('srv-reg-parser').value;
                payload.registration_expiry_days = parseInt(document.getElementById('srv-reg-days').value) || 0;
                payload.code_expiry_days = parseInt(document.getElementById('srv-code-days').value) || 30;
                payload.tos = document.getElementById('srv-tos').value;
                payload.nsfw_enabled = document.getElementById('srv-nsfw').checked;
            } else {
                payload.request_notify_topic_id = parseInt(document.getElementById('srv-req-topic').value) || 0;
                payload.path_mappings = Array.from(document.querySelectorAll('.mapping-item')).map(div => ({
                    remote: div.querySelector('.remote').value,
                    local: div.querySelector('.local').value
                })).filter(m => m.remote && m.local);
            }

            if (currentServerId) {
                await api(`/servers/${currentServerId}`, 'PATCH', payload);
            } else {
                payload.server_type = type;
                await api('/servers', 'POST', payload);
            }
            closeModal('server-modal');
            loadData();
        }

        async function deleteServer() {
            if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
            await api(`/servers/${currentServerId}`, 'DELETE');
            closeModal('server-modal');
            loadData();
        }

        // Helpers
        function fillTopicSelect(id, val) {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="0">æœªè®¾ç½®</option>';
            topicList.forEach(t => sel.add(new Option(t.name, t.id, false, t.id == val)));
        }
        function openModal(id, title=null) {
            if(title) document.getElementById('modal-title').innerText = title;
            document.querySelector(`#${id}`).style.display = 'flex';
            setTimeout(() => document.querySelector(`#${id} .modal`).classList.add('open'), 10);
        }
        function closeModal(id) {
            document.querySelector(`#${id} .modal`).classList.remove('open');
            setTimeout(() => document.querySelector(`#${id}`).style.display = 'none', 300);
        }
        async function toggleAdmin(uid, cb) { try { await api(`/admins/${uid}/toggle`, 'POST'); } catch(e) { cb.checked = !cb.checked; } }
        async function toggleSystem(key) { try { await api(`/system/${key}/toggle`, 'POST'); } catch(e) { document.getElementById(`toggle-${key.split('_')[1]}`).checked = !document.getElementById(`toggle-${key.split('_')[1]}`).checked; } }

        loadData();
    </script>
</body>
</html>